workflows:
  ios-release:
    name: iOS Build & Publish
    integrations:
      app_store_connect: "anga7"
    environment:
      ios_signing:
        provisioning_profiles:
          - angah_provisioning
        certificates:
          - angah_certific
      vars:
        DOTNET_VERSION: "9.0.100"
        PROJECT_PATH: "Ang7.csproj"
        DOTNET_CLI_TELEMETRY_OPTOUT: "1"
        BUNDLE_ID: "com.onmediawll.ang7"

    scripts:
      - name: Install .NET SDK (user-local)
        script: |
          curl -L https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --version $DOTNET_VERSION
          export PATH="$PATH:$HOME/.dotnet:$HOME/.dotnet/tools"
          dotnet --version

      - name: Verify .NET installation
        script: |
          export PATH="$PATH:$HOME/.dotnet:$HOME/.dotnet/tools"
          which dotnet
          dotnet --version

      - name: Install .NET SDK
        script: |
          curl -L https://dot.net/v1/dotnet-install.sh -o dotnet-install.sh
          chmod +x dotnet-install.sh
          ./dotnet-install.sh --version $DOTNET_VERSION
          export PATH=$PATH:$HOME/.dotnet:$HOME/.dotnet/tools
          dotnet --version

      - name: Restore dependencies
        script: |
          export PATH="$PATH:$HOME/.dotnet:$HOME/.dotnet/tools"
          dotnet restore $PROJECT_PATH

      - name: Build iOS
        script: |
          export PATH=$PATH:$HOME/.dotnet:$HOME/.dotnet/tools
          dotnet publish $PROJECT_PATH -f net9.0-ios -c Release \
            -p:RuntimeIdentifier=ios-arm64 \
            -p:PlatformTarget=arm64 \
            -p:CodesignKey="Apple Distribution" \
            -p:CodesignProvision="angah_provisioning" \
            -o ./artifacts/ios/

    artifacts:
      - ./artifacts/ios/**/*.ipa

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
        submit_to_app_store: true
